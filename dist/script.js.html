<script>
  window.addEventListener('load', async () => {
    console.log('page loading ...');
  
    // カテゴリー別の色設定（BASE FOOD商品用）
    const categoryColors = {
      'BASE BREAD': '#ff6b6b',      // 赤系
      'BASE Cookies': '#4ecdc4',     // 青緑系
      'BASE PASTA': '#ffe66d',       // 黄色系
      'BASE YAKISOBA': '#ff9f43',    // オレンジ系
      'Others': '#95a5a6'            // グレー系
    };
  
    const startDate = '2022/01/01';
    const endDate = '2025/01/01';
  
    const array2d = await getCsvDataFromSpreadsheet();
    const csvText = array2d.map(row => row.join(',')).join('\n');
    console.log(csvText); //仮
    const data = parseCsvToObjects(csvText);
    console.log(data[0]); //仮
    const chart = renderChart(data);
  
    /**
     * CSV文字列をパースし、オブジェクトの配列を返す関数
     * @param {string} csv - CSV形式の文字列
     * @param {string} [delimiter=','] - 区切り文字（デフォルトはカンマ）
     * @return {Array<Object>} - オブジェクトの配列
     */
    function parseCsvToObjects(csv, delimiter = ',') {
      const rows = csv.trim().split('\n').filter(row => row.trim());
      if (rows.length < 2) throw new Error('Invalid CSV: Missing data rows');
  
      const headers = rows[0].split(delimiter).map(header => header.trim());
      return rows.slice(1).map(row => {
        const values = row.split(delimiter).map(value => value.trim());
        if (values.length !== headers.length) {
          throw new Error(`Row does not match header count: ${row}`);
        }
        return headers.reduce((obj, header, index) => {
          obj[header] = parseValue(values[index]);
          return obj;
        }, {});
      });
    }
  
    /**
     * 値を適切な型に変換する関数
     * @param {string} value - 値（文字列）
     * @return {any} - 適切な型に変換された値
     */
    function parseValue(value) {
      if (!isNaN(value)) return Number(value); // 数値
      if (value.toLowerCase() === 'true') return true; // 真偽値
      if (value.toLowerCase() === 'false') return false; // 真偽値
      const date = Date.parse(value);
      if (!isNaN(date)) return new Date(date); // 日付
      return value; // 文字列
    }
  
    async function getCsvDataFromSpreadsheet() {
      // サーバー側からデータが返ってくるのを待つために Promise でラップ
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((data) => {
            console.log("GASから渡ってきた値:", data[0]); // デバッグ用
            resolve(data);
          })
          .withFailureHandler((error) => {
            console.error('データの取得に失敗しました', error);
            reject(error);
          })
          .getSheetDataOperation();
      });
    }
  
    function renderChart(data) {  
      let stopped = true;
      let timer;
      const frameDelay = 100;
      let currentDate = startDate;
  
      const chartOptions = {
        debug: true,
        width: 600,
        type: 'horizontal column solid',
        animation: { duration: 500 },
        margin: {
          top: 0,
          right: 50,
          bottom: 0,
          left: 0,
        },
        yAxis: {
          scale_range: { padding: 0.1, min: 0 },
          orientation: 'opposite',
          overflow: 'hidden'
        },
        xAxis: {
          defaultTick_enabled: false,
          scale: { invert: true },
          alternateGridFill: 'none'
        },
        title: {
          position: 'center',
          label: {
            margin_bottom: 40,
            text: 'BASE FOOD 商品別販売数推移'
          }
        },
        annotations: [
          {
            id: 'year',
            label: {
              text: formatAnnotation(new Date(startDate))
            },
            position: 'inside right'
          }
        ],
        legend: {
          template: '%icon %name',
          position: 'inside top right',
          layout: 'vertical',
          margin_top: 50,
          customEntries: [
            { name: 'BASE BREAD', icon: { color: categoryColors['BASE BREAD'] } },
            { name: 'BASE Cookies', icon: { color: categoryColors['BASE Cookies'] } },
            { name: 'BASE PASTA', icon: { color: categoryColors['BASE PASTA'] } },
            { name: 'BASE YAKISOBA', icon: { color: categoryColors['BASE YAKISOBA'] } },
            { name: 'Others', icon: { color: categoryColors['Others'] } }
          ]
        },
        defaultPoint: { label_text: '%id: <b>%yvalue</b>' },
        defaultSeries: {
          legendEntry_visible: false,
          mouseTracking_enabled: false
        },
        series: makeSeries(data),
        toolbar: {
          defaultItem: {
            position: 'inside top',
            offset: '0,-65',
            boxVisible: false,
            margin: 6
          },
          items: {
            startLabel: {
              type: 'label',
              label_text: new Date(startDate).getFullYear().toString()
            },
            slider: {
              type: 'range',
              width: 240,
              debounce: 200,
              value: new Date(startDate).getTime(),
              min: new Date(startDate).getTime(),
              max: new Date(endDate).getTime(),
              events_change: function(val) {
                moveSlider(val);
                playPause(true);
              }
            },
            endLabel: {
              type: 'label',
              label_text: new Date(endDate).getFullYear().toString()
            },
            Pause: {
              type: 'option',
              value: false,
              width: 50,
              margin: [6, 6, 6, 16],
              icon_name: 'system/default/pause',
              label_text: 'Pause',
              events_change: function(val) {
                playPause(!stopped);
              }
            }
          }
        }
      };
  
      const chart = JSC.chart('chartDiv', chartOptions, function(c) {
        playPause(false, c);
      });
  
      return chart;
  
      function makeSeries(data) {
        const dateStr = `${currentDate}`;
        
        // 現在の日付で値が0または未定義、またはitemが空の商品を除外
        const filteredData = data.filter(item => {
          const value = item[dateStr];
          const hasValidItem = item.item && item.item.trim() !== '';
          return hasValidItem && value && value > 0;
        });
        
        filteredData.sort((a, b) => b[dateStr] - a[dateStr]);
  
        return [
          {
            points: filteredData.map((item, index) => ({
              x: index,
              id: item.item,
              y: item[dateStr],
              color: categoryColors[item.category]
            }))
          }
        ];
      }
  
      function moveSlider(date, cb) {
        const dt = new Date(date);
        currentDate = JSC.formatDate(new Date(dt.getFullYear(), dt.getMonth(), 1), 'yyyy/MM/dd');
  
        chart.annotations('year').options({ label_text: formatAnnotation(dt) });
        chart.uiItems('slider').options({ value: dt.getTime() });
  
        chart.series(0).options({ points: makeSeries(data)[0].points }, { then: cb });
      }
  
      function animateChart() {
        if (!stopped) {
          timer = setTimeout(() => {
            const dt = new Date(currentDate);
            currentDate = dt.setMonth(dt.getMonth() + 1);
            if (currentDate >= new Date(endDate).getTime()) {
              clearTimeout(timer);
              playPause(true);
            } else {
              moveSlider(currentDate, animateChart);
            }
          }, frameDelay);
        }
      }
  
      function playPause(val, chrt) {
        const c = chrt || chart;
        if (val) {
          if (!stopped) {
            c.uiItems('Pause').options({ label_text: 'Play', icon_name: 'system/default/play' });
            clearTimeout(timer);
            stopped = true;
          }
        } else {
          if (stopped) {
            c.uiItems('Pause').options({ label_text: 'Pause', icon_name: 'system/default/pause' });
            stopped = false;
            animateChart();
          }
        }
      }
  
      function formatAnnotation(dt) {
        const year = dt.getFullYear();
        const month = dt.toLocaleString('ja-JP', { month: 'short' });
        return (
          `<span style="font-size:20px; font-weight:bold; width:20px; vertical-align:middle">${month}</span>` +
          `<span style="font-size:40px; font-weight:bold; width:130px; align:right;">${year}</span><br>` +
          `合計販売数:<br>` +
          `<span style="font-size:24px; font-weight:bold; width:180px;margin:0 0 0 -2px">{%sum:n0}</span>`
        );
      }
    }
  });
  </script>
  