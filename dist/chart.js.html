<script>
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/ui/chart_racer.js":
/*!*******************************!*\
  !*** ./src/ui/chart_racer.js ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   ChartRacer: () => (/* binding */ ChartRacer)
/* harmony export */ });
/* harmony import */ var ui_config_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ui/config.js */ "./src/ui/config.js");


class ChartRacer {
  constructor(config, data) {
    this.config = config;
    this.data = data;
    this.chart = null;
    this.stopped = true;
    this.timer = null;
    this.currentDate = this.config.startDate;
  }

  init() {
    this._renderChart();
  }

  _renderChart() {
    const chartOptions = {
      debug: true,
      width: 600,
      type: 'horizontal column solid',
      animation: { duration: 500 },
      margin: { top: 0, right: 50, bottom: 0, left: 0 },
      defaultPoint: { label_text: '%id: <b>%yvalue</b>' },
      defaultSeries: { legendEntry_visible: false, mouseTracking_enabled: false },
      series: this._makeSeries(),
      annotations: [{ id: 'year', label: { text: this._formatAnnotation(new Date(this.config.startDate)) }, position: 'inside right' }],

      // 設定をメソッド呼び出しに置き換え
      title: this._buildTitleOptions(),
      yAxis: this._buildYAxisOptions(),
      xAxis: this._buildXAxisOptions(),
      legend: this._buildLegendOptions(),
      toolbar: this._buildToolbarOptions(),
    };

    this.chart = JSC.chart('chartDiv', chartOptions, (c) => {
      this._playPause(false, c);
    });
  }

  _buildTitleOptions() {
    return { position: 'center', label: { margin_bottom: 40, text: this.config.title } };
  }

  _buildYAxisOptions() {
    return { scale_range: { padding: 0.1, min: 0 }, orientation: 'opposite', overflow: 'hidden' };
  }

  _buildXAxisOptions() {
    return { defaultTick_enabled: false, scale: { invert: true }, alternateGridFill: 'none' };
  }

  _buildLegendOptions() {
    return {
      template: '%icon %name',
      position: 'inside top right',
      layout: 'vertical',
      margin_top: 50,
      customEntries: Object.keys(ui_config_js__WEBPACK_IMPORTED_MODULE_0__.categoryColors).map(key => ({ name: key, icon: { color: ui_config_js__WEBPACK_IMPORTED_MODULE_0__.categoryColors[key] } }))
    };
  }

  _buildToolbarOptions() {
    return {
      defaultItem: { position: 'inside top', offset: '0,-65', boxVisible: false, margin: 6 },
      items: {
        startLabel: { type: 'label', label_text: new Date(this.config.startDate).getFullYear().toString() },
        slider: {
          type: 'range',
          width: 240,
          debounce: 200,
          value: new Date(this.config.startDate).getTime(),
          min: new Date(this.config.startDate).getTime(),
          max: new Date(this.config.endDate).getTime(),
          events_change: (val) => {
            this._moveSlider(val);
            this._playPause(true);
          }
        },
        endLabel: { type: 'label', label_text: new Date(this.config.endDate).getFullYear().toString() },
        Pause: {
          type: 'option',
          value: false,
          width: 50,
          margin: [6, 6, 6, 16],
          icon_name: 'system/default/pause',
          label_text: 'Pause',
          events_change: () => {
            this._playPause(!this.stopped);
          }
        }
      }
    };
  }

  _makeSeries() {
    const dateStr = this.currentDate;
    const filteredData = this.data.filter(item => {
      const value = item[dateStr];
      const hasValidItem = item.item && item.item.trim() !== '';
      return hasValidItem && value && value > 0;
    });

    filteredData.sort((a, b) => b[dateStr] - a[dateStr]);

    return [{
      points: filteredData.map((item, index) => ({
        x: index,
        id: item.item,
        y: item[dateStr],
        color: ui_config_js__WEBPACK_IMPORTED_MODULE_0__.categoryColors[item.category]
      }))
    }];
  }

  _moveSlider(date, cb) {
    const dt = new Date(date);
    this.currentDate = JSC.formatDate(new Date(dt.getFullYear(), dt.getMonth(), 1), 'yyyy/MM/dd');

    this.chart.annotations('year').options({ label_text: this._formatAnnotation(dt) });
    this.chart.uiItems('slider').options({ value: dt.getTime() });

    this.chart.series(0).options({ points: this._makeSeries()[0].points }, { then: cb });
  }

  _animateChart() {
    if (!this.stopped) {
      this.timer = setTimeout(() => {
        const dt = new Date(this.currentDate);
        const newDate = dt.setMonth(dt.getMonth() + 1);
        if (newDate >= new Date(this.config.endDate).getTime()) {
          clearTimeout(this.timer);
          this._playPause(true);
        } else {
          this._moveSlider(newDate, () => this._animateChart());
        }
      }, this.config.frameDelay);
    }
  }

  _playPause(val, chrt) {
    const c = chrt || this.chart;
    if (val) {
      if (!this.stopped) {
        c.uiItems('Pause').options({ label_text: 'Play', icon_name: 'system/default/play' });
        clearTimeout(this.timer);
        this.stopped = true;
      }
    } else {
      if (this.stopped) {
        c.uiItems('Pause').options({ label_text: 'Pause', icon_name: 'system/default/pause' });
        this.stopped = false;
        this._animateChart();
      }
    }
  }

  _formatAnnotation(dt) {
    const year = dt.getFullYear();
    const month = dt.toLocaleString('ja-JP', { month: 'short' });
    return (
      `<span style="font-size:20px; font-weight:bold; width:20px; vertical-align:middle">${month}</span>` +
      `<span style="font-size:40px; font-weight:bold; width:130px; align:right;">${year}</span><br>` +
      `合計販売数:<br>` +
      `<span style="font-size:24px; font-weight:bold; width:180px;margin:0 0 0 -2px">{%sum:n0}</span>`
    );
  }
}


/***/ }),

/***/ "./src/ui/config.js":
/*!**************************!*\
  !*** ./src/ui/config.js ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   categoryColors: () => (/* binding */ categoryColors)
/* harmony export */ });
// カテゴリー別の色設定（BASE FOOD商品用）
const categoryColors = {
  'BASE BREAD': '#ff6b6b',      // 赤系
  'BASE Cookies': '#4ecdc4',     // 青緑系
  'BASE PASTA': '#ffe66d',       // 黄色系
  'BASE YAKISOBA': '#ff9f43',    // オレンジ系
  'Others': '#95a5a6'            // グレー系
};


/***/ }),

/***/ "./src/ui/data_utils.js":
/*!******************************!*\
  !*** ./src/ui/data_utils.js ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   fetchAndParseChartData: () => (/* binding */ fetchAndParseChartData),
/* harmony export */   getChartInitialData: () => (/* binding */ getChartInitialData),
/* harmony export */   parseCsvToObjects: () => (/* binding */ parseCsvToObjects)
/* harmony export */ });
/**
 * 値を適切な型に変換する関数
 * @param {string} value - 値（文字列）
 * @return {any} - 適切な型に変換された値
 */
function parseValue(value) {
  if (!isNaN(value)) return Number(value); // 数値
  if (value.toLowerCase() === 'true') return true; // 真偽値
  if (value.toLowerCase() === 'false') return false; // 真偽値
  const date = Date.parse(value);
  if (!isNaN(date)) return new Date(date); // 日付
  return value; // 文字列
}

/**
 * CSV文字列をパースし、オブジェクトの配列を返す関数
 * @param {string} csv - CSV形式の文字列
 * @param {string} [delimiter=','] - 区切り文字（デフォルトはカンマ）
 * @return {Array<Object>} - オブジェクトの配列
 */
function parseCsvToObjects(csv, delimiter = ',') {
  const rows = csv.trim().split('\n').filter(row => row.trim());
  if (rows.length < 2) throw new Error('Invalid CSV: Missing data rows');

  const headers = rows[0].split(delimiter).map(header => header.trim());
  return rows.slice(1).map(row => {
    const values = row.split(delimiter).map(value => value.trim());
    if (values.length !== headers.length) {
      throw new Error(`Row does not match header count: ${row}`);
    }
    return headers.reduce((obj, header, index) => {
      obj[header] = parseValue(values[index]);
      return obj;
    }, {});
  });
}

/**
 * スプレッドシートから初期データ（シートデータと設定）を取得する
 * @returns {Promise<{sheetData: Array<Array<string>>, config: object}>}
 */
async function getChartInitialData() {
  // サーバー側からデータが返ってくるのを待つために Promise でラップ
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler((initialData) => {
        resolve(initialData);
      })
      .withFailureHandler((error) => {
        console.error('初期データの取得に失敗しました。サーバーサイドでエラーが発生しました。');
        console.error('エラー詳細:', error); // エラーオブジェクト全体を出力
        reject(error);
      })
      .getChartInitialDataOperation();
  });
}

/**
 * サーバーからデータを取得し、クライアントサイドで利用可能な形式に整形する
 * @returns {Promise<{config: object, data: Array<Object>}>}
 */
async function fetchAndParseChartData() {
  const initialData = await getChartInitialData();
  if (!initialData || !initialData.config || !initialData.sheetData) {
    throw new Error("Invalid initial data structure from server.");
  }

  const csvText = initialData.sheetData.map(row => row.join(',')).join('\n');
  const data = parseCsvToObjects(csvText);

  return {
    config: initialData.config,
    data: data,
  };
}


/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/global */
/******/ 	(() => {
/******/ 		__webpack_require__.g = (function() {
/******/ 			if (typeof globalThis === 'object') return globalThis;
/******/ 			try {
/******/ 				return this || new Function('return this')();
/******/ 			} catch (e) {
/******/ 				if (typeof window === 'object') return window;
/******/ 			}
/******/ 		})();
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
var __webpack_exports__ = {};
// This entry needs to be wrapped in an IIFE because it needs to be isolated against other modules in the chunk.
(() => {
/*!*************************!*\
  !*** ./src/ui/index.js ***!
  \*************************/
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _chart_racer_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./chart_racer.js */ "./src/ui/chart_racer.js");
/* harmony import */ var _data_utils_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./data_utils.js */ "./src/ui/data_utils.js");



window.addEventListener('load', async () => {
  try {
    const { config, data } = await (0,_data_utils_js__WEBPACK_IMPORTED_MODULE_1__.fetchAndParseChartData)();
    new _chart_racer_js__WEBPACK_IMPORTED_MODULE_0__.ChartRacer(config, data).init();
  } catch (error) {
    console.error("Chart initialization failed:", error);
  }
});
})();

/******/ })()
;</script>
